<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.lotte.chamomile.admin.user.domain.UserPreviousPasswordMapper">

  <!-- 특정 유저의 가장 오래된 비밀번호 삭제 -->
  <delete id="deleteOldestPassword" parameterType="String">
    DELETE FROM CHMM_USER_PREVIOUS_PASSWORDS
    WHERE PREVIOUS_PASSWORDS_ID = (
        SELECT A.PREVIOUS_PASSWORDS_ID
          FROM (
              SELECT
                  ROW_NUMBER() OVER (ORDER BY CHANGED_AT ASC) ROWNO,
                  PREVIOUS_PASSWORDS_ID
                FROM CHMM_USER_PREVIOUS_PASSWORDS
               WHERE user_id = #{userId}
              ) A
         WHERE A.ROWNO = 1
          )
  </delete>

  <!-- 특정 유저의 모든 비밀번호 가져오기 -->
  <select id="getAllPasswordsByUserId" parameterType="string" resultType="string">
    SELECT PASSWORD_HASH FROM CHMM_USER_PREVIOUS_PASSWORDS WHERE USER_ID = #{userId} ORDER BY CHANGED_AT DESC
  </select>

  <!-- 새로운 비밀번호 저장 -->
  <insert id="insertNewPassword" parameterType="map">
    INSERT INTO CHMM_USER_PREVIOUS_PASSWORDS (user_id, password_hash, changed_at)
    VALUES (#{userId}, #{passwordHash}, CURRENT_TIMESTAMP)
  </insert>

</mapper>
